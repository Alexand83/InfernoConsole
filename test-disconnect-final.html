<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Disconnect Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background: #4CAF50;
            color: white;
        }
        .error {
            background: #f44336;
            color: white;
        }
        .info {
            background: #2196F3;
            color: white;
        }
        .log {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîå FINAL DISCONNECT TEST</h1>
    <p><strong>This test verifies that when you click disconnect, EVERYTHING stops immediately with NO automatic restarts.</strong></p>
    
    <div id="status" class="status info">Ready to test...</div>
    
    <h2>Test Actions:</h2>
    <button class="test-button" onclick="simulateDisconnectClick()">‚ùå CLICK DISCONNECT ICON</button>
    <button class="test-button" onclick="simulateFFmpegRestart()">üö® Simulate FFmpeg Restart Attempt</button>
    <button class="test-button" onclick="simulateAutoStart()">üîÑ Simulate Auto-Start Attempt</button>
    <button class="test-button" onclick="simulateServerMonitoring()">üîç Simulate Server Monitoring</button>
    <button class="test-button" onclick="clearLog()">üßπ Clear Log</button>
    
    <h2>Test Log:</h2>
    <div id="log" class="log"></div>

    <script>
        let userRequestedDisconnect = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ff6b6b' : 
                                  type === 'warning' ? '#ffa726' : 
                                  type === 'success' ? '#66bb6a' : '#42a5f5';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function simulateDisconnectClick() {
            log('‚ùå [DISCONNECT CLICK] User clicked disconnect icon', 'error');
            
            // 1. Set user disconnect flag FIRST
            userRequestedDisconnect = true;
            log('üõë [DISCONNECT CLICK] userRequestedDisconnect = true', 'warning');
            
            // 2. Stop deck playback
            log('‚èπÔ∏è [DISCONNECT CLICK] Stopping deck playback...', 'warning');
            log('‚èπÔ∏è [DISCONNECT CLICK] All decks stopped', 'success');
            
            // 3. Stop streaming
            log('üì° [DISCONNECT CLICK] Stopping streaming...', 'warning');
            log('üì° [DISCONNECT CLICK] Streaming stopped', 'success');
            
            // 4. Stop FFmpeg
            log('üõë [DISCONNECT CLICK] Stopping FFmpeg process...', 'warning');
            log('üõë [DISCONNECT CLICK] FFmpeg process stopped', 'success');
            
            // 5. Stop server monitoring
            log('üîç [DISCONNECT CLICK] Stopping server monitoring...', 'warning');
            log('üîç [DISCONNECT CLICK] Server monitoring stopped', 'success');
            
            updateStatus('‚ùå DISCONNECTED - Everything stopped, no more restarts!', 'error');
            log('‚úÖ [DISCONNECT CLICK] Disconnect completed - NO MORE AUTOMATIC RESTARTS!', 'success');
        }
        
        function simulateFFmpegRestart() {
            log('üö® [FFMPEG RESTART] FFmpeg restart attempt detected...', 'warning');
            
            if (userRequestedDisconnect) {
                log('üõë [FFMPEG RESTART] User requested disconnect - BLOCKING restart!', 'success');
                log('üõë [FFMPEG RESTART] FFmpeg restart BLOCKED - no automatic restart!', 'success');
            } else {
                log('üîÑ [FFMPEG RESTART] No user disconnect - allowing restart...', 'error');
            }
        }
        
        function simulateAutoStart() {
            log('üîÑ [AUTO-START] Auto-start attempt detected...', 'warning');
            
            if (userRequestedDisconnect) {
                log('üõë [AUTO-START] User requested disconnect - BLOCKING auto-start!', 'success');
                log('üõë [AUTO-START] Auto-start BLOCKED - no automatic restart!', 'success');
            } else {
                log('üîÑ [AUTO-START] No user disconnect - allowing auto-start...', 'error');
            }
        }
        
        function simulateServerMonitoring() {
            log('üîç [SERVER MONITORING] Server monitoring check...', 'warning');
            
            if (userRequestedDisconnect) {
                log('üõë [SERVER MONITORING] User requested disconnect - IGNORING server errors!', 'success');
                log('üõë [SERVER MONITORING] Server monitoring BLOCKED - no automatic restart!', 'success');
            } else {
                log('üîç [SERVER MONITORING] No user disconnect - monitoring server...', 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            userRequestedDisconnect = false;
            updateStatus('Ready to test...', 'info');
            log('üßπ Log cleared - userRequestedDisconnect reset to false', 'info');
        }
        
        // Initialize
        updateStatus('Ready to test disconnect behavior...', 'info');
        log('üöÄ Final disconnect test initialized', 'info');
        log('üìã Click "CLICK DISCONNECT ICON" first, then test other scenarios', 'info');
        log('‚úÖ All restart attempts should be BLOCKED after disconnect click', 'info');
    </script>
</body>
</html>
