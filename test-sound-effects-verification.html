<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Effects Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #2196F3; }
        .warning { background: #ff9800; }
    </style>
</head>
<body>
    <h1>üéµ Sound Effects AudioContext Fix Test</h1>
    
    <div id="status" class="status info">
        Initializing test...
    </div>
    
    <h2>Test Sound Effects:</h2>
    <button class="test-button" onclick="testSoundEffect('beep')">üîî Beep</button>
    <button class="test-button" onclick="testSoundEffect('horn')">üìØ Horn</button>
    <button class="test-button" onclick="testSoundEffect('applause')">üëè Applause</button>
    <button class="test-button" onclick="testSoundEffect('swoosh')">üí® Swoosh</button>
    <button class="test-button" onclick="testSoundEffect('drop')">üéµ Drop</button>
    
    <h2>Test Results:</h2>
    <div id="results"></div>

    <script>
        let soundEffectsManager = null;
        let testResults = [];

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function addResult(test, success, message) {
            const result = { test, success, message, timestamp: new Date().toLocaleTimeString() };
            testResults.push(result);
            
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${test}</strong> - ${success ? '‚úÖ' : '‚ùå'} ${message}
                <small>(${result.timestamp})</small>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        async function initializeTest() {
            updateStatus('Checking AudioContext availability...', 'info');
            
            // Test 1: Check if ensureMainAudioContext is available
            if (typeof window.ensureMainAudioContext === 'function') {
                addResult('ensureMainAudioContext', true, 'Function is available');
                
                // Test 2: Create main AudioContext
                const mainContext = window.ensureMainAudioContext();
                if (mainContext) {
                    addResult('Main AudioContext', true, `Created successfully (state: ${mainContext.state})`);
                    
                    // Test 3: Check global exposure
                    if (window.globalAudioContext) {
                        addResult('Global AudioContext', true, 'Exposed globally');
                        
                        // Test 4: Initialize SoundEffectsManager
                        if (window.SoundEffectsManager) {
                            try {
                                soundEffectsManager = new window.SoundEffectsManager();
                                soundEffectsManager.setCallbacks({
                                    onDebug: (msg) => console.log('üéµ [SOUND EFFECTS]', msg),
                                    onError: (err) => console.error('‚ùå [SOUND EFFECTS]', err)
                                });
                                
                                // Wait for initialization
                                await new Promise(resolve => setTimeout(resolve, 2000));
                                
                                if (soundEffectsManager.isReady()) {
                                    addResult('SoundEffectsManager', true, 'Initialized successfully');
                                    updateStatus('‚úÖ All tests passed! Sound effects should work now.', 'success');
                                } else {
                                    addResult('SoundEffectsManager', false, 'Failed to initialize');
                                    updateStatus('‚ùå SoundEffectsManager initialization failed', 'error');
                                }
                            } catch (error) {
                                addResult('SoundEffectsManager', false, `Error: ${error.message}`);
                                updateStatus('‚ùå Error creating SoundEffectsManager', 'error');
                            }
                        } else {
                            addResult('SoundEffectsManager Class', false, 'Not available');
                            updateStatus('‚ùå SoundEffectsManager class not found', 'error');
                        }
                    } else {
                        addResult('Global AudioContext', false, 'Not exposed globally');
                        updateStatus('‚ùå Global AudioContext not available', 'error');
                    }
                } else {
                    addResult('Main AudioContext', false, 'Failed to create');
                    updateStatus('‚ùå Failed to create main AudioContext', 'error');
                }
            } else {
                addResult('ensureMainAudioContext', false, 'Function not available');
                updateStatus('‚ùå ensureMainAudioContext not available', 'error');
            }
        }

        async function testSoundEffect(effectId) {
            if (!soundEffectsManager) {
                addResult(`Sound Effect ${effectId}`, false, 'SoundEffectsManager not initialized');
                return;
            }

            try {
                const success = await soundEffectsManager.playSoundEffect(effectId, 0.7);
                if (success) {
                    addResult(`Sound Effect ${effectId}`, true, 'Played successfully');
                } else {
                    addResult(`Sound Effect ${effectId}`, false, 'Playback failed');
                }
            } catch (error) {
                addResult(`Sound Effect ${effectId}`, false, `Error: ${error.message}`);
            }
        }

        // Initialize test when page loads
        window.addEventListener('load', initializeTest);
    </script>
</body>
</html>
