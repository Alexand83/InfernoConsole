name: Build and Release Inferno Console

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    
    # ‚úÖ FIX: Permessi per il token GitHub
    permissions:
      contents: write
      packages: write
      id-token: write
    
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        # macOS commentato - da rifare in seguito
        # os: [windows-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js (Latest)
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        check-latest: true
        cache: 'npm'

    - name: Upgrade npm to latest
      run: npm i -g npm@latest

    - name: Install dependencies
      run: npm ci || npm install

    - name: Build application
      run: npm run build

    - name: Build Electron app (Windows)
      if: matrix.os == 'windows-latest'
      run: npm run dist:win:portable
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Create Self-Extracting Installer (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        Write-Host "Creating self-extracting installer for Windows..."
        Set-Location dist-electron
        
        # Trova il file .exe generato
        $EXE_FILE = Get-ChildItem -Name "*.exe" | Select-Object -First 1
        Write-Host "Found executable: $EXE_FILE"
        
        # Crea un installer PowerShell che include tutto
        $installerScript = @"
        # Inferno Console Self-Extracting Installer
        param([string]$InstallDir = [System.IO.Path]::Combine([System.Environment]::GetFolderPath('Desktop'), 'Inferno Console'))
        
        Write-Host "========================================"
        Write-Host "   INFERNO CONSOLE - INSTALLER"
        Write-Host "========================================"
        Write-Host ""
        
        # Crea directory di installazione
        if (-not (Test-Path $InstallDir)) {
            New-Item -ItemType Directory -Path $InstallDir -Force | Out-Null
            Write-Host "[INFO] Directory creata: $InstallDir"
        } else {
            Write-Host "[INFO] Directory esistente: $InstallDir"
        }
        
        # Estrai i file dell'applicazione (simulato - in realt√† i file sono gi√† presenti)
        Write-Host "[INFO] Copiando file applicazione..."
        $SourceDir = Join-Path $PSScriptRoot "win-unpacked"
        if (Test-Path $SourceDir) {
            Copy-Item -Path "$SourceDir\*" -Destination $InstallDir -Recurse -Force
            Write-Host "[OK] File applicazione copiati"
        } else {
            Write-Host "[ERRORE] Directory win-unpacked non trovata"
            exit 1
        }
        
        # Crea shortcut desktop
        Write-Host "[INFO] Creazione shortcut desktop..."
        $WshShell = New-Object -comObject WScript.Shell
        $DesktopShortcut = $WshShell.CreateShortcut([System.IO.Path]::Combine([System.Environment]::GetFolderPath('Desktop'), 'Inferno Console.lnk'))
        $DesktopShortcut.TargetPath = Join-Path $InstallDir "Inferno Console.exe"
        $DesktopShortcut.WorkingDirectory = $InstallDir
        $DesktopShortcut.Description = "Inferno Console - DJ Software"
        $DesktopShortcut.Save()
        Write-Host "[OK] Shortcut desktop creato"
        
        # Crea shortcut Start Menu
        Write-Host "[INFO] Creazione shortcut Start Menu..."
        $StartMenuShortcut = $WshShell.CreateShortcut([System.IO.Path]::Combine([System.Environment]::GetFolderPath('StartMenuPrograms'), 'Inferno Console.lnk'))
        $StartMenuShortcut.TargetPath = Join-Path $InstallDir "Inferno Console.exe"
        $StartMenuShortcut.WorkingDirectory = $InstallDir
        $StartMenuShortcut.Description = "Inferno Console - DJ Software"
        $StartMenuShortcut.Save()
        Write-Host "[OK] Shortcut Start Menu creato"
        
        Write-Host ""
        Write-Host "[OK] Installazione completata!"
        Write-Host "Premi INVIO per avviare Inferno Console..."
        Read-Host | Out-Null
        Start-Process -FilePath (Join-Path $InstallDir "Inferno Console.exe")
        "@
        
        $installerScript | Out-File -FilePath "Inferno-Console-Installer.ps1" -Encoding UTF8
        
        # Crea un wrapper batch che esegue PowerShell
        $batchWrapper = @"
        @echo off
        echo ========================================
        echo    INFERNO CONSOLE - INSTALLER
        echo ========================================
        echo.
        echo [INFO] Avvio installer...
        powershell -ExecutionPolicy Bypass -File "%~dp0Inferno-Console-Installer.ps1"
        "@
        
        $batchWrapper | Out-File -FilePath "Inferno-Console-Installer.exe" -Encoding ASCII
        
        Write-Host "Self-extracting installer created: Inferno-Console-Installer.exe"
        Write-Host "Installer size: $((Get-Item 'Inferno-Console-Installer.exe').Length) bytes"

    - name: Generate latest.yml for Windows
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        Write-Host "Generating latest.yml for Windows..."
        Set-Location dist-electron
        
        # Usa l'installer self-extracting invece del file portabile
        $INSTALLER_FILE = "Inferno-Console-Installer.exe"
        $INSTALLER_SIZE = (Get-Item $INSTALLER_FILE).Length
        $INSTALLER_SHA512 = (Get-FileHash -Path $INSTALLER_FILE -Algorithm SHA512).Hash.ToLower()
        
        # Crea latest.yml per l'installer self-extracting
        $latestYml = @"
        version: ${{ github.ref_name }}
        files:
          - url: $INSTALLER_FILE
            sha512: $INSTALLER_SHA512
            size: $INSTALLER_SIZE
        path: $INSTALLER_FILE
        sha512: $INSTALLER_SHA512
        releaseDate: '$(Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ")'
        "@
        
        $latestYml | Out-File -FilePath "latest.yml" -Encoding UTF8
        
        Write-Host "Generated latest.yml for installer:"
        Get-Content latest.yml

    - name: Create Desktop Shortcut (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        Write-Host "Creating desktop shortcut for Windows..."
        Set-Location dist-electron
        
        # Trova il file .exe generato
        $EXE_FILE = Get-ChildItem -Name "*.exe" | Select-Object -First 1
        $EXE_PATH = (Get-Item $EXE_FILE).FullName
        
        # Crea script PowerShell per creare collegamento
        $shortcutScript = @"
        `$WshShell = New-Object -comObject WScript.Shell
        `$DesktopPath = [Environment]::GetFolderPath("Desktop")
        `$ShortcutPath = Join-Path `$DesktopPath "Inferno Console.lnk"
        `$Shortcut = `$WshShell.CreateShortcut(`$ShortcutPath)
        `$Shortcut.TargetPath = "$EXE_PATH"
        `$Shortcut.WorkingDirectory = (Split-Path "$EXE_PATH")
        `$Shortcut.Description = "Inferno Console - Professional DJ Console"
        `$Shortcut.Save()
        Write-Host "Desktop shortcut created: `$ShortcutPath"
        "@
        
        $shortcutScript | Out-File -FilePath "create_shortcut.ps1" -Encoding UTF8
        Write-Host "Shortcut script created, ready for user to run"

    # macOS build commentato - da rifare in seguito
    # - name: Build Electron app (macOS)
    #   if: matrix.os == 'macos-latest'
    #   run: npm run dist
    #   env:
    #     CSC_IDENTITY_AUTO_DISCOVERY: false
    #     GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Create Release (Windows)
      if: matrix.os == 'windows-latest' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Inferno Console ${{ github.ref_name }}
        body: |
          ## üéµ Inferno Console ${{ github.ref_name }}
          
          ### ‚ú® Nuove Funzionalit√†
          - Sistema di streaming continuo migliorato
          - Fix auto-reconnessione dopo disconnessione manuale
          - Nickname DJ personalizzabile per Icecast
          - Interfaccia utente ottimizzata
          
          ### üêõ Bug Fix
          - Risolto problema di auto-reconnessione indesiderata
          - Migliorato controllo deck audio durante disconnessione
          - Fix logging per debug del sistema di retry
          
          ### üì¶ Download
          **Windows**: Scarica `Inferno-Console-Installer.exe` - Installer self-extracting
          
          ### üöÄ Installazione
          1. Scarica `Inferno-Console-Installer.exe`
          2. Esegui l'installer (si auto-estrae e installa)
          3. L'app si avvia automaticamente!
          
          ### ‚ú® Caratteristiche Installer
          - **Singolo file .exe** - tutto incluso
          - **Auto-estrazione** - nessuna dipendenza esterna
          - **Shortcut automatici** - Desktop e Start Menu
          - **Compatibile con electron-updater**
          
          ### üìù Note
          - Versione sviluppata da Alessandro(NeverAgain)
          - Licenza MIT
          - Supporto completo per streaming Icecast
        files: |
          dist-electron/Inferno-Console-Installer.exe
          dist-electron/latest.yml
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      continue-on-error: true

    # macOS release commentato - da rifare in seguito
    # - name: Create Release (macOS)
    #   if: matrix.os == 'macos-latest' && startsWith(github.ref, 'refs/tags/')
    #   uses: softprops/action-gh-release@v1
    #   with:
    #     tag_name: ${{ github.ref_name }}
    #     name: Inferno Console ${{ github.ref_name }}
    #     body: |
    #       ## üéµ Inferno Console ${{ github.ref_name }}
    #       
    #       ### ‚ú® Nuove Funzionalit√†
    #       - Sistema di streaming continuo migliorato
    #       - Fix auto-reconnessione dopo disconnessione manuale
    #       - Nickname DJ personalizzabile per Icecast
    #       - Interfaccia utente ottimizzata
    #       
    #       ### üêõ Bug Fix
    #       - Risolto problema di auto-reconnessione indesiderata
    #       - Migliorato controllo deck audio durante disconnessione
    #       - Fix logging per debug del sistema di retry
    #       
    #       ### üì¶ Download
    #       Scegli la versione per il tuo sistema operativo:
    #       
    #       **Windows**: Installa il file `.exe` per Windows 10/11
    #       **macOS**: Installa il file `.dmg` per macOS 10.15+
    #       
    #       ### üöÄ Installazione
    #       1. Scarica il file appropriato per il tuo sistema
    #       2. Esegui l'installer (Windows/macOS)
    #       3. Avvia Inferno Console e goditi la tua sessione DJ!
    #       
    #       ### üìù Note
    #       - Versione sviluppata da Alessandro(NeverAgain)
    #       - Licenza MIT
    #       - Supporto completo per streaming Icecast
    #     files: |
    #       dist-electron/*.dmg
    #       dist-electron/*.zip
    #     draft: false
    #     prerelease: false
    #     generate_release_notes: true
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
    #   continue-on-error: true

    - name: Upload Release Assets Manually
      if: failure()
      run: |
        echo "‚ö†Ô∏è Release automatico fallito, ma il build √® stato completato!"
        echo "üì¶ I file sono disponibili nella directory dist/"
        echo "üéØ Puoi creare manualmente il release su GitHub:"
        echo "   1. Vai su https://github.com/Alexand83/InfernoConsole/releases"
        echo "   2. Clicca 'Create a new release'"
        echo "   3. Seleziona il tag ${{ github.ref_name }}"
        echo "   4. Carica i file dalla directory dist/"
        echo "   5. Pubblica il release"
